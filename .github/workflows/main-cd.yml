name: CD - Deploy to Production

on:
  # Set to run after build and images is completed
  workflow_run:
    workflows: ["Build and Push Images"]
    types: [completed]
    branches: [main]

permissions:
  contents: read
  id-token: write

jobs:
  get-version:
    name: CD - Deployment Version Tag
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v6

      - name: Get Version Tag from CI
        id: version
        uses: ./.github/actions/get-version-tag
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

  deploy-backend:
    name: Deploy Production Backend
    needs: get-version
    runs-on: ubuntu-latest
    environment: production
    outputs:
      revision: ${{ steps.deploy-cloud-run.outputs.revision }}
    steps:
      - uses: actions/checkout@v6

      - name: Authenticate Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

        # Deploys backend image to Cloud Run, outputs deployment revision names for revision history
        # Retries 3 times with delay to account for transient failures
      - name: Deploy Backend to Cloud Run
        id: deploy-cloud-run
        run: |
          for i in {1..3}; do
            echo "Attempt $i: Deploying to Cloud Run..."
            if gcloud run deploy dev1004-backend \
              --image=docker.io/${{ secrets.DOCKERHUB_USERNAME }}/dev1004-backend:${{ needs.get-version.outputs.tag }} \
              --region=us-west1 \
              --allow-unauthenticated \
              --memory=256Mi \
              --update-secrets="DATABASE_URI=DATABASE_URI:latest,JWT_SECRET_KEY=JWT_SECRET_KEY:latest" \
              --format='json' > deploy-output.json; then
              echo "Deployment successful!"
              break
            else
              echo "Deployment failed, waiting 15 seconds before retry..."
              sleep 15
            fi
          done

          REVISION=$(jq -r '.status.latestReadyRevisionName' deploy-output.json)
          echo "revision=$REVISION" >> $GITHUB_OUTPUT

      - name: Get Revision History
        run: |
          mkdir -p revision-history
          gcloud run revisions list \
            --service=dev1004-backend \
            --region=us-west1 \
            --format='json' > revision-history/history.json

          gcloud run revisions list \
            --service=dev1004-backend \
            --region=us-west1 \
            --format='table(name, status.conditions[0].status, createTime.date("%Y-%m-%d %H:%M"), age)' \
            --limit=10 >revision-history/history.txt

      - name: Upload Revision History
        uses: actions/upload-artifact@v6
        with:
          name: revision-history-${{ needs.get-version.outputs.tag }}
          path: revision-history/
          retention-days: 30

  verify-backend:
    name: Verify Backend Deployment Status
    needs: deploy-backend
    runs-on: ubuntu-latest
    steps:
      - name: Wait for deployment
        run: sleep 10

      - name: Verify Backend
        run: |
          BACKEND_URL="https://dev1004-backend-792536546710.us-west1.run.app/"
          curl -f $BACKEND_URL || exit 1
          echo "Backend verified. (revision: ${{ needs.deploy-backend.outputs.revision }})" >> $GITHUB_STEP_SUMMARY

  deploy-frontend:
    name: Deploy Production Frontend
    needs: [get-version, verify-backend]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/setup-env
        with:
          directory: ./frontend

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Build Frontend
        working-directory: ./frontend
        run: npm run build

      - name: Deploy Frontend to Firebase
        working-directory: ./frontend
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: firebase deploy --only hosting --message "Deploy version ${{ needs.get-version.outputs.tag }}"

  verify-frontend:
    name: Verify Frontend Deployment
    needs: deploy-frontend
    runs-on: ubuntu-latest
    steps:
      - name: Wait for deployment
        run: sleep 10

      - name: Verify Frontend
        run: |
          FRONTEND_URL="https://the-century-screening-room.web.app/"
          curl -f $FRONTEND_URL || exit 1
          echo "Frontend verified" >> $GITHUB_STEP_SUMMARY

  deployment-summary:
    name: Deployment Summary
    needs: [get-version, deploy-backend, verify-backend, deploy-frontend, verify-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: Save Deployment Logs
        run: |
          mkdir -p deployment-logs
          echo "Version: ${{ needs.get-version.outputs.tag }}" > deployment-logs/version.txt
          echo "Backend Revision: ${{ needs.deploy-backend.outputs.revision }}" >> deployment-logs/version.txt
          echo "Timestamp: $(date)" >> deployment-logs/version.txt

      - name: Upload Deployment Logs
        uses: actions/upload-artifact@v6
        with:
          name: deployment-logs-${{ needs.get-version.outputs.tag }}
          path: deployment-logs/

      - name: Workflow Summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "Successfully deployed version ${{ needs.get-version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "## Artifacts Uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- Backend revision history" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment logs" >> $GITHUB_STEP_SUMMARY
